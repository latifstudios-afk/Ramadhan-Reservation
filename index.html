<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Somewhere ¬∑ Galleria Reservation Chart</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=Cinzel:wght@400;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --gold: #C9A84C; --gold-l: #E8C97A; --gold-d: #8a6a2a;
            --red: #9B1C1C; --red-b: #C0392B;
            --blk: #0a0a0a; --card: #111111;
            --txt: #F5EDD8; --muted: rgba(245,237,216,0.42);
            --green: #2a6f4b;
            --table-wood: #b57c48;
        }
        body {
            font-family: 'Montserrat', sans-serif; background: var(--blk); color: var(--txt);
            min-height: 100vh; padding: 10px; touch-action: pan-y pinch-zoom;
            background-image: radial-gradient(ellipse 80% 45% at 50% 0%, rgba(155,28,28,.15) 0%, transparent 70%);
        }
        #chart { max-width: 1400px; margin: 0 auto; }
        
        /* capture mode */
        #chart.capture-mode .dbtn, #chart.capture-mode .btn-add, #chart.capture-mode .btn-add-table,
        #chart.capture-mode .action-btn, #chart.capture-mode .guest-notes,
        #chart.capture-mode input, #chart.capture-mode select,
        #chart.capture-mode .table-item { pointer-events: none; }

        .banner {
            background: linear-gradient(135deg,#1a0000 0%,#2a0808 50%,#1a0000 100%);
            border-bottom: 2px solid var(--gold-d); padding: 16px 20px;
            display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 8px;
        }
        .b-txt { font-family: 'Cinzel', serif; font-size: clamp(10px,3vw,13px); font-weight: 600; letter-spacing: 3px; color: var(--gold-l); }
        .b-dot { color: var(--red-b); font-size: 12px; }

        .hdr { text-align: center; padding: 20px 10px; }
        .hdr h1 { font-family: 'Cormorant Garamond', serif; font-size: clamp(40px,10vw,68px); font-weight: 300; }
        .hdr h1 em { font-style: italic; color: var(--gold); }
        .divider { display: flex; align-items: center; gap: 10px; max-width: 300px; margin: 8px auto; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: linear-gradient(to right, transparent, var(--gold-d)); }
        .divider::after { background: linear-gradient(to left, transparent, var(--gold-d)); }
        .ts-badge { font-size: 9px; color: var(--gold); opacity: 0.7; margin-top: 4px; }

        .actions-bar {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 5px 0 20px;
        }
        .action-btn {
            font-family: 'Cinzel', serif; font-size: 10px; font-weight: 600; letter-spacing: 1.5px;
            padding: 8px 16px; border-radius: 2px; background: linear-gradient(135deg, var(--gold-d), var(--gold));
            color: #0a0a0a; border: none; box-shadow: 0 0 8px rgba(201,168,76,.2); cursor: pointer;
        }
        .action-btn.reset-btn { background: linear-gradient(135deg,#3b2b2b,#2a1a1a); color: #dac08a; }

        /* floor plans */
        .floor-plans { display: flex; flex-direction: column; gap: 30px; padding: 0 10px; margin-bottom: 30px; }
        @media (min-width: 900px) { .floor-plans { flex-direction: row; } }
        .floor {
            flex: 1; background: #0f0f0f; border-radius: 28px; border: 1px solid rgba(201,168,76,.2);
            padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.8);
        }
        .floor h3 {
            font-family: 'Cinzel', serif; font-size: 22px; letter-spacing: 2px; color: var(--gold-l);
            margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
        }
        .floor-grid {
            position: relative; background: #1a1a1a; height: 480px;
            border-radius: 24px; border: 2px dashed #4d4d4d;
            background-image: linear-gradient(rgba(201,168,76,0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(201,168,76,0.05) 1px, transparent 1px);
            background-size: 50px 50px; overflow: hidden; touch-action: none;
        }

        /* table card ‚Äì all same small size (80x80) */
        .table-item {
            position: absolute; cursor: pointer; user-select: none;
            background: var(--table-wood); 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; color: white; text-shadow: 0 2px 3px black;
            box-shadow: 0 8px 0 #4f3e28, 0 12px 16px rgba(0,0,0,0.7);
            border-bottom: 3px solid #ab7e4a; transition: 0.1s;
            will-change: left, top; touch-action: none; padding: 4px 2px;
            font-size: 10px; line-height: 1.2;
            width: 80px; height: 80px; /* fixed small size */
        }
        .table-item:active { filter: brightness(1.1); transform: scale(1.01); }
        /* shape classes ‚Äì all within 80x80 */
        .table-item.shape-square { border-radius: 6px; }
        .table-item.shape-rectangle { border-radius: 2px; } /* rectangle illusion */
        .table-item.shape-circle { border-radius: 50%; }
        .table-item.shape-oval { border-radius: 50% / 30%; }

        .table-number {
            background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 20px;
            font-size: 11px; color: var(--gold-l); border: 1px solid #b48b4a; margin-bottom: 2px;
        }
        .booking-info {
            background: rgba(0,0,0,0.6); border-radius: 12px; padding: 2px 4px;
            width: 95%; text-align: center; margin: 2px 0; font-size: 8px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .paid-status {
            font-weight: 700; padding: 2px 6px; border-radius: 12px;
            background: rgba(0,0,0,0.5); margin-top: 2px; font-size: 8px;
        }
        .paid-status.paid { color: #a0e0a0; }
        .paid-status.unpaid { color: #f0a0a0; }

        .floor-actions {
            display: flex; justify-content: flex-end; align-items: center; gap: 12px; margin-top: 20px;
        }
        .add-table-panel {
            display: flex; gap: 8px; background: #1e1e1e; padding: 8px 16px; border-radius: 40px;
            border: 1px solid var(--gold-d); flex-wrap: wrap;
        }
        .add-table-panel select {
            background: #2a2a2a; color: var(--gold-l); border: 1px solid #55411e;
            border-radius: 30px; padding: 6px 12px; font-size: 11px; font-weight: 600;
        }
        .btn-add-table {
            background: var(--gold-d); border: none; color: black; font-weight: 600;
            border-radius: 30px; padding: 6px 18px; font-size: 11px; cursor: pointer;
        }

        /* MODAL */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal.show { display: flex; }
        .modal-card {
            background: #1c1c1c; border-radius: 32px; padding: 28px; width: 90%; max-width: 400px;
            border: 2px solid var(--gold-d); box-shadow: 0 20px 40px black;
        }
        .modal-card h2 { font-family: 'Cinzel', serif; color: var(--gold-l); margin-bottom: 20px; }
        .modal-field {
            margin-bottom: 16px; display: flex; flex-direction: column; gap: 4px;
        }
        .modal-field label { font-size: 10px; letter-spacing: 1px; color: var(--muted); }
        .modal-field input, .modal-field select {
            background: #2a2a2a; border: 1px solid #55411e; border-radius: 30px;
            padding: 12px 16px; color: var(--txt); font-size: 14px;
        }
        .modal-buttons { display: flex; gap: 12px; margin-top: 24px; }
        .modal-btn {
            flex: 1; padding: 14px; border-radius: 40px; border: none; font-weight: 600;
            background: var(--gold-d); color: black; cursor: pointer;
        }
        .modal-btn.delete { background: #5a2a2a; color: #f0b0b0; }

        /* reservation sections */
        .sections { display: flex; flex-direction: column; gap: 20px; padding: 0 10px; margin: 20px 0; }
        @media (min-width: 700px) { .sections { flex-direction: row; } }
        .section {
            flex: 1; border-radius: 20px; background: var(--card); border: 1px solid rgba(201,168,76,.18);
        }
        .sec-hdr {
            padding: 16px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(201,168,76,.15);
        }
        .inside .sec-hdr { background: linear-gradient(135deg,#200800,#2d1200); }
        .outside .sec-hdr { background: linear-gradient(135deg,#0a0000,#1f0505); }
        .s-title { font-family: 'Cinzel', serif; font-size: 18px; color: var(--gold-l); }
        .s-sub { font-size: 10px; color: var(--muted); }

        .btn-add {
            background: rgba(201,168,76,.08); border: 1px solid rgba(201,168,76,.2);
            color: var(--gold); border-radius: 30px; padding: 6px 18px; font-size: 10px; cursor: pointer;
        }

        .glist { background: var(--card); }
        .grow {
            display: grid; grid-template-columns: 1fr 50px 90px 70px 1fr 30px; gap: 4px;
            align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,.04);
            font-size: 11px;
        }
        .grow span { overflow: hidden; text-overflow: ellipsis; }
        .dbtn { color: #b66; background: none; border: none; cursor: pointer; font-size: 14px; }

        .stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; padding: 0 10px; margin: 20px 0; }
        .sc {
            background: linear-gradient(135deg,#0f0000,#190404); border: 1px solid rgba(201,168,76,.14);
            border-radius: 16px; padding: 12px 4px; text-align: center;
        }
        .sn { font-family: 'Cormorant Garamond', serif; font-size: 28px; color: var(--gold); }
        .sl { font-size: 8px; letter-spacing: 1px; color: var(--muted); }

        .orn { text-align: center; margin: 15px 0; color: var(--gold-d); letter-spacing: 8px; }
        .ftxt { text-align: center; font-size: 10px; color: rgba(201,168,76,.3); letter-spacing: 3px; }

        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; }
        #overlay.show { display: flex; }
        .spin { width: 40px; height: 40px; border: 3px solid rgba(201,168,76,.2); border-top-color: var(--gold); border-radius: 50%; animation: spin .8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div id="overlay"><div class="spin"></div><div class="ov-txt">Generating ‚Ä¶</div></div>

<!-- MODAL for booking -->
<div id="bookingModal" class="modal">
    <div class="modal-card">
        <h2 id="modalTitle">Table T-<span id="modalTableNum"></span></h2>
        <div class="modal-field">
            <label>Customer name</label>
            <input type="text" id="modalName" placeholder="e.g. Salma" value="">
        </div>
        <div class="modal-field">
            <label>Number of guests</label>
            <input type="number" id="modalGuests" min="1" value="2">
        </div>
        <div class="modal-field">
            <label>Time</label>
            <input type="time" id="modalTime" value="19:30">
        </div>
        <div class="modal-field">
            <label>Payment</label>
            <select id="modalPaid">
                <option value="paid">PAID</option>
                <option value="unpaid">UNPAID</option>
            </select>
        </div>
        <div class="modal-field">
            <label>Table nature</label>
            <select id="modalShape">
                <option value="square">Square</option>
                <option value="rectangle">Rectangle</option>
                <option value="circle">Circle</option>
                <option value="oval">Oval</option>
            </select>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn" id="modalSaveBtn">SAVE</button>
            <button class="modal-btn delete" id="modalDeleteBtn">CLEAR</button>
        </div>
        <div style="text-align:center; margin-top:12px">
            <button class="modal-btn" id="modalCancelBtn" style="background:#333; color:#ccc;">CANCEL</button>
        </div>
    </div>
</div>

<div id="chart">
    <div class="banner">
        <span class="b-txt">SOMEWHERE</span> <span class="b-dot">‚óÜ</span>
        <span class="b-txt">GALLERIA MALL</span> <span class="b-dot">‚óÜ</span>
        <span class="b-txt">Reservations Chart</span>
    </div>
    <div class="hdr">
        <h1>Table <em>Manager</em></h1>
        <div class="divider"><span>‚ú¶</span></div>
        <div class="ts-badge" id="timestamp">just now</div>
    </div>
    <div class="actions-bar">
        <button class="action-btn" onclick="downloadPDF()">üìÑ FULL PDF</button>
        <button class="action-btn" onclick="downloadPNG()">üñºÔ∏è FULL PNG</button>
        <button class="action-btn" onclick="exportReservations()">üìã EXPORT LIST</button>
        <button class="action-btn reset-btn" onclick="resetToSample()">‚Ü∫ RESET</button>
    </div>

    <!-- FLOOR PLANS (Inside / Outside) -->
    <div class="floor-plans" id="floorPlans"></div>

    <!-- RESERVATION SECTIONS -->
    <div class="sections" id="sectionsContainer"></div>

    <div class="stats">
        <div class="sc"><div class="sn" id="stat-res">0</div><div class="sl">BOOKINGS</div></div>
        <div class="sc"><div class="sn" id="stat-seated">0</div><div class="sl">SEATED</div></div>
        <div class="sc"><div class="sn" id="stat-noshow">0</div><div class="sl">NO-SHOW</div></div>
        <div class="sc"><div class="sn" id="stat-tables">0</div><div class="sl">TABLES</div></div>
    </div>
    <div class="orn">‚Äî ‚ú¶ ‚Äî</div>
    <div class="ftxt">LS ¬∑ Luxury Seating Simplified</div>
</div>

<script>
    (function() {
        // ---------- DATA MODELS ----------
        let tables = { inside: [], outside: [] };
        let reservations = { inside: [], outside: [] };

        function uid() { return Date.now() + '-' + Math.random().toString(36).substr(2, 9); }

        // Table numbers from images
        const insideNumbers = [11,14,16,17,18,19,20,30,32,33,35,37,38];
        const outsideNumbers = [41,42,44,45,46,50,51,52,53,54,55,56];

        function createDefaultTables() {
            const inside = insideNumbers.sort((a,b)=>a-b).map((num, idx) => ({
                id: uid(), number: num, capacity: 4, paid: false,
                shape: ['square','rectangle','circle','oval'][idx % 4],
                position: { x: 40 + (idx % 4) * 130, y: 40 + Math.floor(idx / 4) * 120 } // closer together due to smaller tables
            }));
            // adjust capacities
            inside.forEach(t => {
                if ([20,32,17,11,18].includes(t.number)) t.capacity = 4;
                else if ([16,14,19].includes(t.number)) t.capacity = 2;
                else if ([37,35,38,33,30].includes(t.number)) t.capacity = 6;
            });
            const outside = outsideNumbers.sort((a,b)=>a-b).map((num, idx) => ({
                id: uid(), number: num, capacity: 4,
                shape: ['square','rectangle','circle','oval'][idx % 4],
                position: { x: 40 + (idx % 4) * 130, y: 40 + Math.floor(idx / 4) * 120 }
            }));
            outside.forEach(t => {
                if ([42,46,56,50].includes(t.number)) t.capacity = 2;
                else if ([45,55,54,41,44].includes(t.number)) t.capacity = 6;
            });
            return { inside, outside };
        }

        function createDefaultReservations(tableList) {
            return {
                inside: [
                    { id: uid(), name: 'Salma', partySize: 8, tableId: tableList.inside.find(t=>t.number===20)?.id, status: 'confirmed', paid: true, time: '19:30' },
                    { id: uid(), name: 'Wadha', partySize: 6, tableId: tableList.inside.find(t=>t.number===32)?.id, status: 'seated', paid: true, time: '20:00' },
                    { id: uid(), name: 'Maythaa', partySize: 4, tableId: tableList.inside.find(t=>t.number===17)?.id, status: 'no-show', paid: false, time: '18:45' },
                ],
                outside: [
                    { id: uid(), name: 'Baker', partySize: 5, tableId: tableList.outside.find(t=>t.number===45)?.id, status: 'seated', paid: true, time: '19:00' },
                    { id: uid(), name: 'Suleiman', partySize: 5, tableId: tableList.outside.find(t=>t.number===55)?.id, status: 'seated', paid: true, time: '19:15' },
                    { id: uid(), name: 'Noorah', partySize: 2, tableId: tableList.outside.find(t=>t.number===56)?.id, status: 'confirmed', paid: true, time: '20:30' },
                    { id: uid(), name: 'Aisha', partySize: 2, tableId: tableList.outside.find(t=>t.number===46)?.id, status: 'confirmed', paid: false, time: '19:45' },
                    { id: uid(), name: 'Shahad', partySize: 3, tableId: tableList.outside.find(t=>t.number===45)?.id, status: 'no-show', paid: false, time: '18:30' },
                    { id: uid(), name: 'Seem', partySize: 2, tableId: tableList.outside.find(t=>t.number===42)?.id, status: 'confirmed', paid: true, time: '21:00' },
                ]
            };
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('SeatingCompactShapes');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.tables && parsed.reservations) {
                        tables = parsed.tables;
                        reservations = parsed.reservations;
                        return;
                    }
                } catch (e) {}
            }
            tables = createDefaultTables();
            reservations = createDefaultReservations(tables);
        }
        loadFromStorage();

        function save() {
            localStorage.setItem('SeatingCompactShapes', JSON.stringify({ tables, reservations }));
            updateTimestamp();
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').innerText = `updated ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
        }

        // ---------- MODAL ----------
        let currentModalZone = null, currentModalTableId = null;

        function openModal(zone, tableId) {
            currentModalZone = zone; currentModalTableId = tableId;
            const table = tables[zone].find(t => t.id === tableId);
            if (!table) return;
            document.getElementById('modalTableNum').innerText = table.number;
            const existing = reservations[zone].find(r => r.tableId === tableId);
            document.getElementById('modalName').value = existing ? existing.name : '';
            document.getElementById('modalGuests').value = existing ? existing.partySize : table.capacity;
            document.getElementById('modalTime').value = existing ? (existing.time || '19:30') : '19:30';
            document.getElementById('modalPaid').value = existing ? (existing.paid ? 'paid' : 'unpaid') : 'unpaid';
            document.getElementById('modalShape').value = table.shape || 'square';
            document.getElementById('bookingModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('bookingModal').classList.remove('show');
            currentModalZone = null; currentModalTableId = null;
        }

        document.getElementById('modalSaveBtn').addEventListener('click', () => {
            if (!currentModalZone || !currentModalTableId) return;
            const zone = currentModalZone;
            const tableId = currentModalTableId;
            const name = document.getElementById('modalName').value.trim();
            const guests = parseInt(document.getElementById('modalGuests').value, 10) || 1;
            const time = document.getElementById('modalTime').value;
            const paid = document.getElementById('modalPaid').value === 'paid';
            const shape = document.getElementById('modalShape').value;

            const table = tables[zone].find(t => t.id === tableId);
            if (table) table.shape = shape;

            const existingIndex = reservations[zone].findIndex(r => r.tableId === tableId);
            if (existingIndex >= 0) {
                reservations[zone][existingIndex].name = name || 'Guest';
                reservations[zone][existingIndex].partySize = guests;
                reservations[zone][existingIndex].time = time;
                reservations[zone][existingIndex].paid = paid;
            } else {
                reservations[zone].push({
                    id: uid(), name: name || 'Guest', partySize: guests, tableId: tableId,
                    status: 'confirmed', paid: paid, time: time
                });
            }
            renderAll();
            closeModal();
        });

        document.getElementById('modalDeleteBtn').addEventListener('click', () => {
            if (!currentModalZone || !currentModalTableId) return;
            const zone = currentModalZone;
            const tableId = currentModalTableId;
            reservations[zone] = reservations[zone].filter(r => r.tableId !== tableId);
            renderAll();
            closeModal();
        });

        document.getElementById('modalCancelBtn').addEventListener('click', closeModal);

        // ---------- RENDER ----------
        function renderAll() {
            renderFloorPlans();
            renderReservationSections();
            updateStats();
            save();
        }

        function renderFloorPlans() {
            const container = document.getElementById('floorPlans');
            container.innerHTML = '';
            ['inside', 'outside'].forEach(zone => {
                const floorDiv = document.createElement('div');
                floorDiv.className = 'floor';
                floorDiv.innerHTML = `<h3>${zone === 'inside' ? 'INSIDE' : 'OUTSIDE'}</h3>
                    <div class="floor-grid" id="floor-${zone}"></div>
                    <div class="floor-actions">
                        <div class="add-table-panel">
                            <select id="pax-${zone}">
                                <option value="2">2 pax</option>
                                <option value="4" selected>4 pax</option>
                                <option value="6">6 pax</option>
                                <option value="8">8 pax</option>
                            </select>
                            <select id="shape-${zone}">
                                <option value="square">Square</option>
                                <option value="rectangle">Rectangle</option>
                                <option value="circle">Circle</option>
                                <option value="oval">Oval</option>
                            </select>
                            <button class="btn-add-table" onclick="addTableWithSize('${zone}')">+ Add table</button>
                        </div>
                    </div>`;
                container.appendChild(floorDiv);
                const grid = document.getElementById(`floor-${zone}`);
                const sortedTables = [...tables[zone]].sort((a,b) => a.number - b.number);
                sortedTables.forEach(table => {
                    if (!table.position) table.position = { x: 60, y: 60 };
                    const tableEl = document.createElement('div');
                    tableEl.className = `table-item shape-${table.shape || 'square'}`;
                    tableEl.setAttribute('data-id', table.id);
                    tableEl.setAttribute('data-zone', zone);
                    tableEl.style.left = (table.position?.x || 60) + 'px';
                    tableEl.style.top = (table.position?.y || 60) + 'px';

                    const res = reservations[zone].find(r => r.tableId === table.id);
                    const customerName = res ? res.name : '';
                    const guestCount = res ? res.partySize : '';
                    const paidText = res ? (res.paid ? 'PAID' : 'UNPAID') : '';
                    
                    tableEl.innerHTML = `
                        <div class="table-number">T-${table.number}</div>
                        ${customerName ? `<div class="booking-info">${customerName} (${guestCount})</div>` : ''}
                        ${paidText ? `<div class="paid-status ${res.paid ? 'paid' : 'unpaid'}">${paidText}</div>` : ''}
                    `;
                    grid.appendChild(tableEl);
                    makeDraggable(tableEl, zone, table.id);
                    tableEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openModal(zone, table.id);
                    });
                });
            });
        }

        function makeDraggable(el, zone, tableId) {
            let startX, startY, startLeft, startTop, isDragging = false;
            const grid = el.parentNode;

            function onPointerDown(e) {
                e.preventDefault();
                const pointer = e.touches ? e.touches[0] : e;
                startX = pointer.clientX; startY = pointer.clientY;
                const rect = el.getBoundingClientRect();
                const gridRect = grid.getBoundingClientRect();
                startLeft = rect.left - gridRect.left;
                startTop = rect.top - gridRect.top;
                isDragging = true;
                el.classList.add('dragging');
                window.addEventListener('pointermove', onPointerMove);
                window.addEventListener('pointerup', onPointerUp);
                window.addEventListener('pointercancel', onPointerUp);
            }

            function onPointerMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                const pointer = e.touches ? e.touches[0] : e;
                const dx = pointer.clientX - startX;
                const dy = pointer.clientY - startY;
                const gridRect = grid.getBoundingClientRect();
                let newLeft = startLeft + dx;
                let newTop = startTop + dy;
                newLeft = Math.max(0, Math.min(gridRect.width - el.offsetWidth, newLeft));
                newTop = Math.max(0, Math.min(gridRect.height - el.offsetHeight, newTop));
                el.style.left = newLeft + 'px';
                el.style.top = newTop + 'px';
            }

            function onPointerUp() {
                if (isDragging) {
                    isDragging = false;
                    el.classList.remove('dragging');
                    const table = tables[zone].find(t => t.id === tableId);
                    if (table) {
                        table.position = { x: parseFloat(el.style.left) || 0, y: parseFloat(el.style.top) || 0 };
                        save();
                    }
                }
                window.removeEventListener('pointermove', onPointerMove);
                window.removeEventListener('pointerup', onPointerUp);
                window.removeEventListener('pointercancel', onPointerUp);
            }
            el.addEventListener('pointerdown', onPointerDown);
            el.addEventListener('dragstart', (e) => e.preventDefault());
        }

        function renderReservationSections() {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = '';
            ['inside', 'outside'].forEach(zone => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = `section ${zone}`;
                sectionDiv.innerHTML = `
                    <div class="sec-hdr">
                        <div>
                            <div class="s-title">${zone === 'inside' ? 'INSIDE' : 'OUTSIDE'}</div>
                            <div class="s-sub" id="${zone}-sub">${reservations[zone].length} groups</div>
                        </div>
                        <button class="btn-add" onclick="addEmptyReservation('${zone}')">+ Add guest</button>
                    </div>
                    <div class="glist" id="${zone}-list"></div>
                `;
                container.appendChild(sectionDiv);
                const listDiv = document.getElementById(`${zone}-list`);
                reservations[zone].forEach(res => {
                    listDiv.appendChild(createResRow(zone, res));
                });
            });
        }

        function createResRow(zone, res) {
            const row = document.createElement('div');
            row.className = 'grow';
            const table = tables[zone].find(t => t.id === res.tableId);
            const tableNum = table ? `T-${table.number}` : '‚Äî';
            row.innerHTML = `
                <span>${res.name}</span>
                <span>${res.partySize}</span>
                <span>${tableNum}</span>
                <span>${res.status}</span>
                <span>${res.paid ? 'PAID' : 'UNPAID'}</span>
                <button class="dbtn" onclick="deleteRes('${zone}', '${res.id}')">‚úï</button>
            `;
            return row;
        }

        window.deleteRes = (zone, resId) => {
            reservations[zone] = reservations[zone].filter(r => r.id !== resId);
            renderAll();
        };

        window.addEmptyReservation = (zone) => {
            reservations[zone].push({ id: uid(), name: 'Guest', partySize: 2, tableId: null, status: 'confirmed', paid: false, time: '19:30' });
            renderAll();
        };

        window.addTableWithSize = (zone) => {
            const paxSelect = document.getElementById(`pax-${zone}`);
            const shapeSelect = document.getElementById(`shape-${zone}`);
            const capacity = parseInt(paxSelect.value, 10);
            const shape = shapeSelect.value;
            const maxNum = tables[zone].length > 0 ? Math.max(...tables[zone].map(t => t.number)) : 0;
            const newNum = maxNum + 1;
            // find free space
            let baseX = 60, baseY = 60;
            for (let attempt = 0; attempt < 30; attempt++) {
                baseX = 40 + (attempt * 40) % 350;
                baseY = 40 + Math.floor(attempt / 8) * 100;
                const collision = tables[zone].some(t => {
                    const dx = (t.position?.x || 0) - baseX;
                    const dy = (t.position?.y || 0) - baseY;
                    return Math.abs(dx) < 70 && Math.abs(dy) < 70; // smaller collision radius
                });
                if (!collision) break;
            }
            const newTable = { id: uid(), number: newNum, capacity: capacity, shape: shape, position: { x: baseX, y: baseY } };
            tables[zone].push(newTable);
            renderAll();
        };

        window.resetToSample = () => {
            if (!confirm('Reset to default layout?')) return;
            tables = createDefaultTables();
            reservations = createDefaultReservations(tables);
            renderAll();
        };

        function updateStats() {
            const allRes = [...reservations.inside, ...reservations.outside];
            document.getElementById('stat-res').innerText = allRes.length;
            document.getElementById('stat-seated').innerText = allRes.filter(r => r.status === 'seated').length;
            document.getElementById('stat-noshow').innerText = allRes.filter(r => r.status === 'no-show').length;
            document.getElementById('stat-tables').innerText = tables.inside.length + tables.outside.length;
            const insideSub = document.getElementById('inside-sub');
            const outsideSub = document.getElementById('outside-sub');
            if (insideSub) insideSub.innerText = `${reservations.inside.length} groups`;
            if (outsideSub) outsideSub.innerText = `${reservations.outside.length} groups`;
        }

        // ----- EXPORT FULL UI -----
        async function capture(mode) {
            const overlay = document.getElementById('overlay');
            overlay.classList.add('show');
            const chart = document.getElementById('chart');
            chart.classList.add('capture-mode');
            try {
                const canvas = await html2canvas(chart, { scale: 2, backgroundColor: '#0a0a0a', logging: false });
                if (mode === 'png') {
                    const link = document.createElement('a');
                    link.download = `seating-${new Date().toISOString().slice(0,10)}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } else {
                    const { jsPDF } = window.jspdf;
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const pdf = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4' });
                    const pageW = pdf.internal.pageSize.getWidth();
                    const pageH = pdf.internal.pageSize.getHeight();
                    const ratio = canvas.height / canvas.width;
                    const imgH = pageW * ratio;
                    if (imgH <= pageH) pdf.addImage(imgData, 'JPEG', 0, 0, pageW, imgH);
                    else {
                        let y = 0;
                        while (y < imgH) {
                            if (y > 0) pdf.addPage();
                            pdf.addImage(imgData, 'JPEG', 0, -y, pageW, imgH);
                            y += pageH;
                        }
                    }
                    pdf.save(`reservations-${new Date().toISOString().slice(0,10)}.pdf`);
                }
            } catch (e) { alert('Export failed'); console.error(e); }
            chart.classList.remove('capture-mode');
            overlay.classList.remove('show');
        }

        // ----- EXPORT RESERVATION LIST (spreadsheet style) -----
        window.exportReservations = () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            let y = 20;
            pdf.setFontSize(16);
            pdf.text('Reservation Details', 20, y);
            y += 10;
            pdf.setFontSize(10);
            // Headers
            const headers = ['Section', 'Name', 'Number', 'Pax', 'Table', 'Status', 'Payment'];
            const colX = [20, 50, 85, 115, 145, 180]; // approximate positions
            pdf.setFont('helvetica', 'bold');
            headers.forEach((h, i) => pdf.text(h, colX[i], y));
            pdf.setFont('helvetica', 'normal');
            y += 6;

            ['inside', 'outside'].forEach(zone => {
                reservations[zone].forEach(res => {
                    if (y > 270) { pdf.addPage(); y = 20; pdf.setFont('helvetica', 'bold'); headers.forEach((h, i) => pdf.text(h, colX[i], y)); pdf.setFont('helvetica', 'normal'); y += 6; }
                    const table = tables[zone].find(t => t.id === res.tableId);
                    const tableNum = table ? `T-${table.number}` : '‚Äî';
                    const row = [
                        zone === 'inside' ? 'Inside' : 'Outside',
                        res.name,
                        res.partySize.toString(),
                        tableNum,
                        res.status,
                        res.paid ? 'PAID' : 'UNPAID'
                    ];
                    row.forEach((text, i) => pdf.text(text, colX[i], y));
                    y += 6;
                });
                y += 2;
            });
            pdf.save('reservation-list.pdf');
        };

        window.downloadPDF = () => capture('pdf');
        window.downloadPNG = () => capture('png');

        renderAll();
    })();
</script>
</body>
</html>
